<script type="text/x-template" id="edit-header-template">
    <div class="page-header">
        <div class="page-header-row page-header-row-nav d-flex flex-wrap align-items-center gap-2">
            <nav class="page-header-breadcrumbs d-print-none">
                <a href="#" @click.prevent="fwStore.openListScreen">{{fwStore.list_title}}</a> <span class="text-muted">/</span>
            </nav>
            <div class="page-header-record-nav ms-auto d-flex align-items-center gap-2 d-print-none">
                <autocomplete v-model="quickSearch"
                              class="form-control-sm fw-quick-search-input"
                              style="width: 220px;"
                              :url="fwStore.base_url + '/(QuickSearch)?q='"
                              placeholder="`Search by ID or name...`"
                              @select="goQuickSearch"
                              @enter="goQuickSearch"></autocomplete>
                <template v-if="current_id">
                    <a @click.prevent="onNext(true)" href="#" class="btn btn-link"><i class="bi bi-arrow-left-circle"></i> `Prev`</a>
                    <a @click.prevent="onNext()" href="#" class="btn btn-link">`Next` <i class="bi bi-arrow-right-circle"></i></a>
                </template>
            </div>
        </div>

        <div class="page-header-row page-header-row-title d-flex flex-wrap align-items-center gap-2">
            <div class="page-header-title flex-grow-1">
                <h1 class="page-title mb-0" v-if="!current_id">{{fwStore.add_new_title}}</h1>
                <h1 class="page-title mb-0" v-if="current_id">{{fwStore.edit_title}}</h1>
            </div>
            <div class="page-header-meta d-flex flex-wrap align-items-center gap-2">
                <span v-if="fwStore.savedStatus!==null" class="form-saved-status-global">
                    <span v-if="fwStore.savedStatus" class="badge text-bg-success">saved</span>
                    <span v-if="!fwStore.savedStatus" class="badge text-bg-danger">not saved</span>
                </span>
                <slot name="meta"></slot>
            </div>
        </div>

        <div class="page-header-row page-header-row-actions d-flex flex-wrap align-items-center gap-2">
            <div class="page-header-actions d-print-none d-flex flex-wrap align-items-center gap-2">
                <slot name="beforeButtons"></slot>

                <div class="btn-group">
                    <a v-if="fwStore.return_url"
                       class="btn btn-default"
                       :href="fwStore.return_url"><i class="bi bi-arrow-left-circle"></i> `Return Back`</a>
                    <a v-else
                       class="btn btn-default"
                       href="#"
                       @click.prevent="onCancelForm"><i class="bi bi-arrow-left-circle"></i> `Back to List`</a>

                    <button v-if="uioptions.btnAddNew"
                            type="button"
                            class="btn btn-default"
                            @click="onAddNew"
                            :disabled="fwStore.is_readonly"><i class="bi bi-plus-lg"></i> `Add New`</button>
                </div>

                <button v-if="current_id"
                        type="button"
                        class="btn btn-default"
                        @click="onView"><i class="bi bi-eye"></i> `View`</button>

                <div class="btn-group" v-if="$slots.group">
                    <slot name="group"></slot>
                </div>

                <slot></slot>
            </div>

            <div class="page-header-actions page-header-actions-extra d-flex flex-wrap align-items-center gap-2 ms-auto">
                <span class="form-saved-status-global"></span>
                <template v-if="!current_id">
                    <button type="button" class="btn btn-primary" :disabled="fwStore.is_readonly" @click="saveChanges">`Save`</button>
                    <button type="button" class="btn btn-secondary" :disabled="fwStore.is_readonly" @click="saveChanges('New')">`Save and Add New`</button>
                    <button type="button" class="btn btn-default" @click="onCancelForm">`Cancel`</button>
                </template>
                <slot name="actions-right"></slot>
            </div>
        </div>
    </div>
</script>

<script type="module">
    import { mapStores } from 'pinia';

    fwApp.component('edit-header', {
        template: '#edit-header-template',
        data: () => ({
            quickSearch: '',
        }),
        computed: {
            ...mapStores(fwStore), //accessible via this.fwStore
            uioptions() {
                return this.fwStore.uioptions.edit.header ?? false;
            },
            current_id() {
                return this.fwStore.current_id ?? 0;
            },
            id() {
                return this.fwStore.edit_data?.id ?? 0;
            }
        },
        methods: {
            async goQuickSearch(value) {
                if (!value) {
                    return;
                }
                const id = AppUtils.idFromAutocomplete(value);
                this.quickSearch = '';
                if (id > 0) {
                    await this.fwStore.openEditScreen(id);
                    return;
                }
                this.fwStore.setFilters({ s: value });
                await this.fwStore.openListScreen();
            },
            async onAddNew(e) {
                await this.fwStore.openEditScreen(0);
            },
            onView(e) {
                this.fwStore.openViewScreen(this.id);
            },
            saveChanges(route_return) {
                if (route_return) {
                    this.fwStore.edit_data.route_return = route_return;
                }
                this.fwStore.saveEditDataDebounced();
            },
            onCancelForm() {
                this.fwStore.openListScreen();
            },
            async onNext(is_prev) {
                const id = await this.fwStore.getNextID(this.current_id, is_prev);
                await this.fwStore.openEditScreen(id);
            }
        }
    });
</script>
