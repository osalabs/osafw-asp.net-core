<!--
  fw_modal component usage:

  1) Add /common/modal include to a load_script.html
  2) Trigger with:
     <button class="on-fw-modal" data-url="/admin/controller/(action)">Open Modal</button>
     - Optional: data-modal-dialog-class / data-modal-content-class to tweak Bootstrap classes.
  3) Lookup modal helpers:
     - data-fw-lookup="add" or "edit" to enable lookup mode.
     - data-fw-lookup-target="#selector" to specify which control to update (defaults to first input/select in input-group).
     - URLs can include {id} placeholder for edit actions (current select value).
     - On save, controller returns JSON with lookup_label; select option is added/updated.
  4) Forms inside modal are submitted via ajaxForm and HTML response replaces modal content.
  5) In modal JS, get the trigger element:
     var trigger = fw.modalTriggerEl(fw.scopeFromScript());
-->
<script>
  fw.initComponent('fw_modal', {
    init: function () {
      var $doc = $(document);
      if ($doc.data('fw-modal-inited')) return;
      $doc.data('fw-modal-inited', true);

      fw._modalCounter = fw._modalCounter || 0;
      fw._modalTriggerCounter = fw._modalTriggerCounter || 0;

      function ensureTriggerId($trigger) {
        var triggerId = $trigger.data('fw-modal-trigger-id');
        if (!triggerId) {
          fw._modalTriggerCounter += 1;
          triggerId = 'fw-modal-trigger-' + Date.now() + '-' + fw._modalTriggerCounter;
          $trigger.attr('data-fw-modal-trigger-id', triggerId);
        }
        return triggerId;
      }

      // Resolve target control for lookup updates
      function resolveLookupTarget($trigger) {
        var targetSelector = $trigger.data('fw-lookup-target');
        if (targetSelector) {
          var $target = $(targetSelector);
          if ($target.length) return $target;
        }

        var $group = $trigger.closest('.input-group');
        if (!$group.length) return $();

        return $group.find('select, input, textarea').first();
      }

      // Build lookup context from trigger data attributes
      function buildLookupContext($trigger) {
        var lookupMode = $trigger.data('fw-lookup');
        if (!lookupMode) return null;

        var $target = resolveLookupTarget($trigger);
        return {
          mode: lookupMode,
          $target: $target
        };
      }

      // Build modal URL, resolving lookup placeholders
      function buildLookupUrl($trigger, lookup) {
        var url = $trigger.data('url') || $trigger.attr('href');
        if (!url) return url;

        if (url.indexOf('{id}') !== -1 || url.indexOf('{value}') !== -1) {
          var value = lookup && lookup.$target && lookup.$target.length ? lookup.$target.val() : '';
          if (!value) {
            fw.alert('Select a value first');
            return null;
          }
          url = url.replace(/\{id\}/g, encodeURIComponent(value));
          url = url.replace(/\{value\}/g, encodeURIComponent(value));
        }

        return url;
      }

      function buildModal($trigger) {
        fw._modalCounter += 1;
        var modalId = 'fw-modal-' + Date.now() + '-' + fw._modalCounter;
        var triggerId = ensureTriggerId($trigger);
        var dialogClass = $trigger.data('modal-dialog-class') || 'modal-dialog modal-lg modal-dialog-scrollable';
        var contentClass = $trigger.data('modal-content-class') || 'modal-content bg-body';

        var $modal = $('<div class="modal fade fw-modal" tabindex="-1" role="dialog" aria-hidden="true"></div>');
        var $dialog = $('<div></div>').addClass(dialogClass);
        var $content = $('<div></div>').addClass(contentClass);

        $modal.attr('id', modalId);
        $modal.attr('data-fw-modal-trigger-id', triggerId);
        $modal.append($dialog.append($content));

        $('body').append($modal);

        $modal.on('hidden.bs.modal', function () {
          var modalEl = this;
          if (typeof bootstrap !== 'undefined' && bootstrap.Modal && typeof bootstrap.Modal.getInstance === 'function') {
            var modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance && typeof modalInstance.dispose === 'function') {
              modalInstance.dispose();
            }
          }
          $modal.remove();
        });

        return $modal;
      }

      function executeModalScripts($container) {
        $container.find('script').each(function () {
          var oldScript = this;
          var newScript = document.createElement('script');

          Array.from(oldScript.attributes).forEach(function (attr) {
            newScript.setAttribute(attr.name, attr.value);
          });

          if (oldScript.src) {
            newScript.src = oldScript.src;
            newScript.async = false;
          } else {
            newScript.text = oldScript.text;
          }

          oldScript.parentNode.replaceChild(newScript, oldScript);
        });
      }

      function setModalContent($modal, html) {
        var $content = $modal.find('.modal-content');
        $content.html(html);
        executeModalScripts($content);
        bindModalForms($modal);
      }

      function escapeHtml(message) {
        return $('<div>').text(message == null ? '' : String(message)).html();
      }

      function showLoadError($modal, message) {
        var safeMessage = escapeHtml(message || '');
        var html = '<div class="modal-body"><div class="alert alert-danger mb-0">' + safeMessage + '</div></div>';
        setModalContent($modal, html);
      }

      function loadModalContent($modal, url) {
        $modal.data('fw-modal-url', url);
        var $content = $modal.find('.modal-content');
        $content.html(fw.HTML_LOADING);

        $.ajax({
          url: url,
          method: 'GET',
          dataType: 'html'
        })
          .done(function (html) {
            setModalContent($modal, html);
          })
          .fail(function (xhr) {
            var message = xhr.responseText || 'Failed to load modal content.';
            showLoadError($modal, message);
          });
      }

      function bindModalForms($modal) {
        if (!$.fn.ajaxForm) return;
        var lookup = $modal.data('fw-lookup') || null;

        $modal.find('form').each(function () {
          var $form = $(this);
          if ($form.data('fw-modal-ajaxform')) return;

          $form.data('fw-modal-ajaxform', true);
          if (lookup) {
            $form.ajaxForm({
              dataType: 'json',
              headers: { Accept: 'application/json' },
              beforeSubmit: function () {
                var $field = $form.find('input[name="lookup"]');
                if (!$field.length) {
                  $field = $('<input type="hidden" name="lookup">').appendTo($form);
                }
                $field.val(lookup.mode || '1');
              },
              success: function (data) {
                if (data && data.error) {
                  fw.clean_form_errors($form);
                  if (data.error.details) {
                    fw.process_form_errors($form, data.error.details);
                  }
                  fw.error(data.error.message || fw.MSG_AUTOSAVE_ERROR);
                  return;
                }

                var id = data && data.id ? data.id : null;
                var label = data && data.lookup_label ? data.lookup_label : null;
                if (!label) {
                  label = $form.find('[name="item[iname]"]').val();
                }

                if (lookup.$target && lookup.$target.length && id) {
                  var idValue = String(id);
                  var $option = lookup.$target.find('option').filter(function () {
                    return $(this).val() === idValue;
                  });
                  if (!$option.length) {
                    $option = $('<option></option>').val(idValue).appendTo(lookup.$target);
                  }
                  if (label) {
                    $option.text(label);
                  }
                  lookup.$target.val(idValue);
                  lookup.$target.trigger('change');
                }

                var instance = bootstrap.Modal.getInstance($modal[0]);
                if (instance) {
                  instance.hide();
                }
              },
              error: function (xhr) {
                var message = xhr.responseJSON?.error?.message || xhr.responseText || 'Failed to submit form.';
                fw.error(message);
              }
            });
            return;
          }

          $form.ajaxForm({
            dataType: 'html',
            success: function (html) {
              setModalContent($modal, html);
            },
            error: function (xhr) {
              var message = xhr.responseText || 'Failed to submit form.';
              showLoadError($modal, message);
            }
          });
        });
      }

      $doc.on('click', '.on-fw-modal', function (e) {
        var $trigger = $(this);
        var lookup = buildLookupContext($trigger);
        var url = buildLookupUrl($trigger, lookup);
        if (!url) return;

        e.preventDefault();
        var $modal = buildModal($trigger);
        if (lookup) {
          $modal.data('fw-lookup', lookup);
        }
        loadModalContent($modal, url);

        var instance = new bootstrap.Modal($modal[0]);
        instance.show();
      });
    }
  });
</script>
