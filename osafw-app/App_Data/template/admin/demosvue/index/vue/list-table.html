<script type="text/x-template" id="list-table-template">
 <div>
  <form class="fw-card" @submit.prevent>
    <input type="hidden" name="_method" value="PUT">

    <div :class="'table-list-wrapper ' + fwStore.user_view.density">
      <div class="table-list-hscroll-hint"><~/common/icons/info-circle-fill> use <kbd>Shift+Mouse Wheel</kbd> for an easy horizontal scrolling
      </div>
      <table :class="'table table-stripedX table-hover list ' + (fwStore.is_list_edit?'list-edit ':'') + fwStore.user_view.density">
        <thead>
            <tr>
              <th><input type="checkbox" name="all" v-model="cb_check_all" @change="onCheckAll"></th>
              <th v-if="fwStore.global.is_list_btn_left"></th>

              <template v-for="header in fwStore.headers">
                <th :class="'rotate'+(header.is_sortable && fwStore.f.sortby==header.field_name ? ' active-sort' : '')"
                  :data-sort="header.is_sortable"
                  @click="(event) => onSortHeader(event, header)">
                  <div>
                    <span>{{header.field_name_visible}}</span>
                    <span class="ms-1" v-if="header.is_sortable && fwStore.f.sortby==header.field_name">
                      <template v-if="fwStore.f.sortdir=='desc'">
                        <!-- desc icon -->
                        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-up" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/></svg>
                      </template>
                      <template v-else>
                        <!-- asc icon -->
                        <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-down" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/></svg>
                      </template>
                    </span>
                  </div>
                </th>
              </template>

              <th v-if="!fwStore.global.is_list_btn_left"></th>
            </tr>
            <tr class="search" :style="fwStore.is_list_search_open ? 'display: table-row' : ''">
              <th></th>
              <th v-if="fwStore.global.is_list_btn_left"></th>
              <th v-for="header in fwStore.headers">
                <input type="text" class="form-control form-control-sm"
                  v-model="header.search_value"
                  @change="fwStore.loadIndexDebounced"
                  @keyup.enter.stop="fwStore.loadIndexDebounced">
              </th>
              <th v-if="!fwStore.global.is_list_btn_left"></th>
            </tr>
        </thead>

        <tbody class="table-group-divider">
          <template v-for="row in fwStore.list_rows" :key="row[fwStore.field_id]">
            <tr data-url="<~row_click_url>"
                :data-id="row[fwStore.field_id]"
                :title="row_title"
                :class="fwStore.hchecked_rows[row[fwStore.field_id]] ? 'selected' : ''"
                @click="(event) => onClickRow(event,row)">

                <td class="list-row-cb"><input class="multicb" type="checkbox" v-model="fwStore.hchecked_rows[row[fwStore.field_id]]"></td>
                <!--TODO make common component for row btn-->
                <td :class="'list-row-controls text-nowrap d-print-none '+(fwStore.global.is_list_btn_left?'':'text-end')" v-if="fwStore.global.is_list_btn_left">
                  <a href="<~../url>/<~id><~/common/list/relid>">`View`</a>
                  <~/common/dot><a href="<~row_click_url>">`Edit`</a>
                  <~/common/dot><a href="<~../url>/<~id>/delete<~/common/list/relid>"
                                    class="text-danger on-delete-list-row"
                                    :disabled="fwStore.is_readonly"><~/common/icons/x></a>
                </td>

                <template v-for="(header, key) in fwStore.headers" :key="key">
                  <td v-if="!fwStore.is_list_edit">{{fieldValueByName(row, header.field_name)}}</td>
                  <td v-else>
                      <!-- editable mode -->
                      <!-- readonly row or column -->
                      <list-cell-ro v-if="header.is_ro || row._meta?.is_ro || row._meta?.ro_fields?.includes(header.field_name)" :row="row" :col="header"></list-cell-ro>
                      <!-- editable row or column -->
                      <list-cell-input v-else-if="header.input_type=='input'"
                        :row="row" :col="header"
                        @change="onCellChange($event, row, header)"
                        ></list-cell-input>
                      <list-cell-email v-else-if="header.input_type=='email'"
                        :row="row" :col="header"
                        @change="onCellChange($event, row, header)"
                        ></list-cell-email>
                      <list-cell-select v-else-if="header.input_type=='select'"
                        :row="row" :col="header"
                        :options="lookupByHeader(header)"
                        @change="onCellChange($event, row, header)"
                        ></list-cell-select>
                      <list-cell-checkbox v-else-if="header.input_type=='cb'"
                        :row="row" :col="header"
                        @change="onCellChange($event, row, header)"
                        ></list-cell-checkbox>
                      <list-cell-date v-else-if="header.input_type=='date_popup'" :row="row" :col="header"></list-cell-date>

                      <td v-else class="text-danger">{{fieldValueByName(row, header.field_name)}}</td>
                  </td>
                </template>

                <!--TODO make common component for row btn-->
                <td :class="'list-row-controls text-nowrap d-print-none '+(fwStore.global.is_list_btn_left?'':'text-end')" v-if="!fwStore.global.is_list_btn_left">
                  <a href="<~../url>/<~id><~/common/list/relid>">`View`</a>
                  <~/common/dot><a href="<~row_click_url>">`Edit`</a>
                  <~/common/dot><a href="<~../url>/<~id>/delete<~/common/list/relid>"
                                    class="text-danger on-delete-list-row"
                                    :disabled="fwStore.is_readonly"><~/common/icons/x></a>
                </td>
            </tr>
          </template>
        </tbody>

      </table>
    </div>

    <div class="text-center py-4" v-if="!fwStore.list_rows.length">
      <h3><~/common/icons/0-square> `No results`</h3>
      Try to <a :href="'?dofilter=1'+(fwStore.related_id ? '&related_id='+fwStore.related_id : '')">reset</a> all filters.
    </div>

    <template v-if="fwStore.list_rows.length">
      <div class="float-md-end pt-2 mb-3 d-print-none">
        <span class="badge"></span><br>
        <div class="d-flex justify-content-md-end">
          <list-pagination
            :pager="fwStore.pager"
            :pagesize="fwStore.f.pagesize"
            @on-page="onClickPage"
            @on-pagesize="onChangePagesize"></list-pagination>
        </div>
      </div>

      <!-- TODO make as a separate extenable component -->
      <div id="list-btn-multi" :class="'mb-3 d-print-none '+(fwStore.countCheckedRows ? 'position-sticky' : '')">
        `with <span class="badge bg-secondary rows-num" v-if="fwStore.countCheckedRows">{{fwStore.countCheckedRows}}</span> checked rows:`<br>
        <input type="submit" name="delete" value="`Delete`" class="btn btn-danger on-delete-multi" <~/common/disabled if="is_readonly">>
        <~/common/list/btn_userlists if="is_userlists">
        <~btn_multidel_more>
      </div>
    </template>

  </form>

  <hr class="d-print-none">
  <form id="FOneDelete" action="<~../url>/%id%?XSS=<~SESSION[XSS]>" method="post" class="d-none">
  </form>

 </div>
</script>

<script type="module">
import { mapStores } from 'pinia';

fwApp.component('list-table', {
  template: '#list-table-template',
  props: [],
  data: () => ({
        row_title: 'Double click to Edit',
        cb_check_all: false
  }),
  computed: {
        ...mapStores(useFwStore) //accessible via this.fwStore
  },
  mounted() {
        console.log('list-table mounted');
  },
  methods: {
    fieldValueByName(row, field_name){
        //return value by field_name in row associative array
        //add here any additional processing if needed
        return row[field_name];
    },
    lookupByHeader(header){
      var lookup_model = header.lookup_model;
      if (lookup_model){
        return this.fwStore.lookups[lookup_model]??[];
      }
      var lookup_tpl = header.lookup_tpl;
      if (lookup_tpl){
        return this.fwStore.lookups[lookup_tpl]??[];
      }
    },
    resetCheckedRows() {
        this.fwStore.hchecked_rows = [];
        this.cb_check_all = false;
    },
    // sorting handlers
    onSortHeader(e, header){
        if (!header.is_sortable) return;

        let new_sortdir = 'asc'; //default sort
        if (this.fwStore.f.sortby == header.field_name) {
            //active column - change sort dir
            new_sortdir = this.fwStore.f.sortdir == 'asc' ? 'desc' : 'asc';
        }

        this.resetCheckedRows();
        this.fwStore.setFilters({sortby: header.field_name, sortdir: new_sortdir});
    },
    // pagination handlers
    onClickPage(e){
      this.resetCheckedRows();
      this.fwStore.setFilters({pagenum:e});
    },
    onChangePagesize(e){
      this.resetCheckedRows();
      this.fwStore.setFilters({pagesize:e});
    },
    //click on row - select/unselect row
    onClickRow(e, row){
        console.log('onClickRow',e);
        var tag_name = e.target.tagName.toLowerCase();
        if (tag_name === 'a'||tag_name === 'button'||tag_name === 'input'||tag_name === 'textarea'||tag_name === 'select'||tag_name === 'option'){
          return; // do not process if link/button/input clicked
        }

        const row_id = row[this.fwStore.field_id];
        this.fwStore.hchecked_rows[row_id] = !this.fwStore.hchecked_rows[row_id];
    },
    //check all/none rows
    onCheckAll(e){
        if (e.target.checked){
            // for each row.id in fwStore.list_rows - add to hchecked_rows
            this.fwStore.hchecked_rows = this.fwStore.list_rows.reduce((acc, row) => {
                acc[row[this.fwStore.field_id]] = true;
                return acc;
            }, {});
        }else{
          this.fwStore.hchecked_rows=[];
        }
    },

    // work with a cell
    onCellChange(e, row, col){
        this.fwStore.saveCell(row, col);
        if (e.keyCode==13){
          //TODO TBD if enter - move to next cell under this one
        }
    },
  }
});
</script>
